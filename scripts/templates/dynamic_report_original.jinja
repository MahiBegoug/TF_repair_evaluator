<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/default.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/diff.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/bash.min.js"></script>
    <title>LLM Fix Report</title>
    <style>
        html, body {
            width: 100%;
            font-family: sans-serif;
        }

        table, th, td {
            border: 1px solid #ccc;
            border-collapse: collapse;
            table-layout: fixed;
        }
        
        th {
            background-color: #f0f0f0;
            padding: 8px;
        }

        td {
            padding: 8px;
            vertical-align: top;
        }

        table {
            width: 100%;
            table-layout: fixed;
        }

        .td-fix {
            width: 90%;
            max-width: 90%;
            overflow-x: auto;
        }

        .td-llm {
            width: 10%;
        }
        
        pre {
            margin: 0;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        
        .controls {
            position: sticky;
            top: 0;
            background: white;
            padding: 10px;
            border-bottom: 1px solid #ccc;
            z-index: 100;
        }
    </style>
</head>
<body>
    <div class="controls">
        <label for="model-select">Filter by Model:</label>
        <select id="model-select" onchange="filterResults()">
            <option value="all">All Models</option>
            {% for model in all_models %}
                <option value="{{ model }}">{{ model }}</option>
            {% endfor %}
        </select>
        
        <label for="iter-select" style="margin-left: 20px;">Filter by Iteration:</label>
        <select id="iter-select" onchange="filterResults()">
            <option value="all">All Iterations</option>
            {% for iter in all_iterations %}
                <option value="{{ iter }}">{{ iter }}</option>
            {% endfor %}
        </select>
    </div>

    <h1>LLM Fix Report</h1>
    {% for k, problems in groups %}
        {% set hash = md5(k) %}
        <div class="problem-group">
            <h2 id="{{ hash }}"><a href="#{{ hash }}"><u>{{ k.project_name }}</u>/{{ k.filename }}</a></h2>
            <ul>
                <li>Lines: {{ k.line_start }}-{{ k.line_end }}</li>
                <li>Severity: {{ k.severity }}</li>
                <li>Summary: {{ k.summary }}</li>
            </ul>
            <table>
                <thead>
                    <tr>
                        <th class="td-llm">LLM</th>
                        <th class="td-fix">Suggested Fix (Diff)</th>
                    </tr>
                </thead>
                <tbody>
                    {% for solution in problems.itertuples() %}
                        <tr class="solution-row" data-model="{{ solution.llm_name }}" data-iter="{{ solution.iteration_id }}">
                            <td class="td-llm">
                                <strong>{{ solution.llm_name|e }}</strong><br>
                                <br>
                                Lines: {{ solution.line_start }}-{{ solution.line_end }}<br>
                                Severity: {{ solution.severity }}<br>
                                Summary: {{ solution.summary }}<br>
                                <strong>Type: {{ solution.fix_type }}</strong><br>
                                <span style="font-size: 0.8em; color: #666;">OID: {{ solution.oid }}</span>
                            </td>
                            <td class="td-fix">
                                {% if solution.diff %}
                                    <pre><code class="language-diff">{{ solution.diff|e }}</code></pre>
                                {% else %}
                                    <span class="no-answer">No diff generated</span>
                                {% endif %}
                                <br>
                                <strong>Explanation:</strong>
                                <blockquote>{{ solution.explanation|e }}</blockquote>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
            <hr>
        </div>
    {% endfor %}
    
    <script>
        hljs.highlightAll();
        
        function filterResults() {
            const selectedModel = document.getElementById('model-select').value;
            const selectedIter = document.getElementById('iter-select').value;
            const rows = document.querySelectorAll('.solution-row');
            
            rows.forEach(row => {
                const model = row.getAttribute('data-model');
                const iter = row.getAttribute('data-iter');
                
                const modelMatch = (selectedModel === 'all' || model === selectedModel);
                const iterMatch = (selectedIter === 'all' || iter === selectedIter);
                
                if (modelMatch && iterMatch) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
            
            // Optional: Hide problem groups if no rows are visible
            document.querySelectorAll('.problem-group').forEach(group => {
                const visibleRows = group.querySelectorAll('.solution-row:not([style*="display: none"])');
                if (visibleRows.length === 0) {
                    group.style.display = 'none';
                } else {
                    group.style.display = '';
                }
            });
        }
    </script>
</body>
</html>
